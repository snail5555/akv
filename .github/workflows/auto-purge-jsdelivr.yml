name: Auto Purge JSDelivr for Updated Images (All Repo)

on:
  push:
    branches:
      - main
    paths:
      - "**"

jobs:
  purge-jsdelivr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get list of updated image files
        id: changed-files
        run: |
          files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(png|jpg|jpeg|webp|gif|svg|js|css|json)$' || true)
          echo "files=$files" >> "$GITHUB_OUTPUT"

      - name: Purge updated files from JSDelivr
        if: ${{ steps.changed-files.outputs.files != '' }}
        run: |
          for file in ${{ steps.changed-files.outputs.files }}; do
            echo "Purging: $file"
            curl -X GET "https://purge.jsdelivr.net/gh/snail5555/akv@main/$file"
          done
